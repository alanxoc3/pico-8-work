pico-8 cartridge // http://www.pico-8.com
version 16
__lua__
-- efficient outline
-- by alan morgan

g_out_cache = {}
function init_out_cache(s_beg, s_end)
   for sind=s_beg,s_end do
      local bounds, is_bkgd = {}, function(x, y)
         return mid(0,x,7) == x and sget(x+sind*8%128, y+flr(sind/16)*8) != 0
      end

      local calc_bound = function(x)
         local top, bot

         for i=0,7 do
            top, bot = top or is_bkgd(x,i) and i-1, bot or is_bkgd(x,7-i) and 8-i
         end

         return {top=top or 10, bot=bot or 0}
      end

      g_out_cache[sind] = {}
      for i=0xffff,8 do
         -- prev, cur, next
         local p, c, n = calc_bound(i-1), calc_bound(i), calc_bound(i+1)
         local top, bot = min(min(p.top, c.top), n.top), max(max(p.bot, c.bot), n.bot)

         if bot >= top then
            add(g_out_cache[sind], {x1=i,y1=top,x2=i,y2=bot})
         end
      end
   end
end

function spr_out(sind, x, y, sw, sh, xf, yf, col)
   local ox, x_mult, oy, y_mult = x, 1, y, 1
   if xf then ox, x_mult = 7+x, 0xffff end
   if yf then oy, y_mult = 7+y, 0xffff end

   foreach(g_out_cache[sind], function(r)
      rectfill(
         ox+x_mult*r.x1,
         oy+y_mult*r.y1,
         ox+x_mult*r.x2,
         oy+y_mult*r.y2,
         col)
   end)

   spr(sind, x, y, sw, sh, xf, yf)
end

function _init()
   -- create outlines for the first 20 sprites.
   init_out_cache(0,127)

   -- pattern colors
   poke(0x5f34, 1)
   outline = "new"
end

function _update()
   if btnp(4) then
      if outline == "new" then
         outline = "old"
      elseif outline == "old" then
         outline = "no"
      elseif outline == "no" then
         outline = "new"
      end
   end
end

function _draw()
   fillp(0b0000011001100000)
   rectfill(0,0,127,127,0xde)
   fillp()
   for j=0,6 do
      for i=0,7 do
         if outline == "new" then
            spr_out(j*16+i, 4+i*16, 4+j*16, 1, 1, false, false, i)
         elseif outline == "old" then
            outline_sprite(j*16+i, 4+i*16, 4+j*16, 1, 1, false, false, j)
         else
            spr(j*16+i, 4+i*16, 4+j*16, 1, 1, false, false)
         end
      end
   end
   print("cpu: "..stat(1), 2, 114, 0)
   print(outline.." outline, press z to switch", 2, 121, 0)
end

-- older function taken from:
-- https://gist.github.com/liquidream/1b419261dc324708f008f24ee6d13d7b
function outline_sprite(n,x,y,w,h,flip_x,flip_y, col_outline)
  -- reset palette to black
  for c=1,15 do
    pal(c,col_outline)
  end
  -- draw outline
  for xx=-1,1 do
    for yy=-1,1 do
      spr(n,x+xx,y+yy,w,h,flip_x,flip_y)
    end
  end
  -- reset palette
  pal()
  -- draw final sprite
  spr(n,x,y,w,h,flip_x,flip_y)	
end

__gfx__
00000000000000000000000000000000000000000000000000000000007666700000000000000000000000000000000000000000000000000000000000000000
000000000f000f000f000f0000777700007777000f000f000eeeee00000050000000000000000000000000000000000000000000000000000000000000000000
007007000ffffff00ffffff0077787700777b7700ffffff0eeeefee0007777000000000000000000000000000000000000000000000000000000000000000000
000770000f1fff100f1fff1007777770077777700f1fff10ef1ff1e0077787700000000000000000000000000000000000000000000000000000000000000000
000770000effffe00effffe007177710071777100effffe0eeffffe0071777100000000000000000000000000000000000000000000000000000000000000000
007007000022200000222000077777700777777000222000eeccce00077777700000000000000000000000000000000000000000000000000000000000000000
000000000088800000888f000999999a099999900f88800000777000099999900000000000000000000000000000000000000000000000000000000000000000
0000000000f0f00000f0000000a000000a0000a00000f0000080800000a000a00000000000000000000000000000000000000000000000000000000000000000
0eeeee000eeeee0000676760000000000eeeee0000000000000000000eeeee000000000000000000000000000000000000000000000000000000000000000000
eeeeeee0eeeeeee0000050000f000f00eeeeeee00077770000000000eeeeeee00000000000000000000000000000000000000000000000000000000000000000
ef1ff1e0ef1ff1e0007777000ffffff0ef1ff1e00777b77000700700ef1ff1e00000000000000000000000000000000000000000000000000000000000000000
eeffffe0eeffffe0077787700f1fff10eeffffe00777777000077000eeffffe00000000000000000000000000000000000000000000000000000000000000000
eeccce00eeccce00071777100effffe0eeccce000717771000077000eeccce000000000000000000000000000000000000000000000000000000000000000000
00777800087770000777777000222000087770000777777000700700087770000000000000000000000000000000000000000000000000000000000000000000
0080000000000800099999900f888000000008000999999000000000000008000000000000000000000000000000000000000000000000000000000000000000
00000000000000000a000a000000f000000000000a0000a000000000000000000000000000000000000000000000000000000000000000000000000000000000
07676767007666700f000f0000000000000000000eeeee0000676760000000000000000000000000000000000000000000000000000000000000000000000000
00005000000050000ffffff0000000000f000f00eeeeeee0000050000f000f000000000000000000000000000000000000000000000000000000000000000000
00777700007777000f1fff10007007000ffffff0ef1ff1e0007777000ffffff00000000000000000000000000000000000000000000000000000000000000000
07778770077787700effffe0000770000f1fff10eeffffe0077787700f1fff100000000000000000000000000000000000000000000000000000000000000000
071777100717771000222000000770000effffe0eeccce00071777100effffe00000000000000000000000000000000000000000000000000000000000000000
077777700777777000888f0000700700002220000877700007777770002220000000000000000000000000000000000000000000000000000000000000000000
09999990099999900f000000000000000f88800000000800099999900f8880000000000000000000000000000000000000000000000000000000000000000000
00a00a0000a000a000000000000000000000f000000000000a000a000000f0000000000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000766670000767000eeeee000000000000000000000000000000000000000000000000000000000000000000
000000000f000f000eeeee0000777700007777000000500000005000eeeeeee00000000000000000000000000000000000000000000000000000000000000000
007007000ffffff0eeeeeee0077787700777b7700077770000777700ef1ff1e00000000000000000000000000000000000000000000000000000000000000000
000770000f1fff10ef1ff1e007777770077777700777877007778770eeffffe00000000000000000000000000000000000000000000000000000000000000000
000770000effffe0eeffffe007177710071777100717771007177710eeccce000000000000000000000000000000000000000000000000000000000000000000
0070070000222000eeccce0007777770077777700777777007777770087770000000000000000000000000000000000000000000000000000000000000000000
0000000000888000087770000999999a099999900999999009999990000008000000000000000000000000000000000000000000000000000000000000000000
0000000000f0f0000000800000a000000a0000a000a000a00a0000a0000000000000000000000000000000000000000000000000000000000000000000000000
0f000f00000000000000000000000000000000000000000000000000007777000000000000000000000000000000000000000000000000000000000000000000
0ffffff00f000f000eeeee000eeeee00000000000f000f000f000f00077787700000000000000000000000000000000000000000000000000000000000000000
0f1fff100ffffff0eeeefee0eeeeeee0007007000ffffff00ffffff0077777700000000000000000000000000000000000000000000000000000000000000000
0effffe00f1fff10ef1ff1e0ef1ff1e0000770000f1fff100f1fff10071777100000000000000000000000000000000000000000000000000000000000000000
002220000effffe0eeffffe0eeffffe0000770000effffe00effffe0077777700000000000000000000000000000000000000000000000000000000000000000
0f88800000222000eeccce00eeccce00007007000022200000222000a99999900000000000000000000000000000000000000000000000000000000000000000
00000f000f8880000077700000777800000000000088800000888f0000000a000000000000000000000000000000000000000000000000000000000000000000
000000000000f00000808000008000000000000000f0f00000f00000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000007777000f000f000eeeee000eeeee0000676760000000000000000000000000000000000000000000000000000000000000000000000000
0077770000777700077787700ffffff0eeeeeee0eeeeeee000005000000000000000000000000000000000000000000000000000000000000000000000000000
077787700777b770077777700f1fff10ef1ff1e0ef1ff1e000777700007007000000000000000000000000000000000000000000000000000000000000000000
0777777007777770071777100effffe0eeffffe0eeffffe007778770000770000000000000000000000000000000000000000000000000000000000000000000
07177710071777100777777000222000eeccce00eeccce0007177710000770000000000000000000000000000000000000000000000000000000000000000000
0777777007777770a99999900f888000007778000877700007777770007007000000000000000000000000000000000000000000000000000000000000000000
0999999a0999999000000a0000000f00008000000000080009999990000000000000000000000000000000000000000000000000000000000000000000000000
00a000000a0000a0000000000000000000000000000000000a000a00000000000000000000000000000000000000000000000000000000000000000000000000
000000000eeeee000067676000000000076767670076667000076700000000000000000000000000000000000000000000000000000000000000000000000000
0f000f00eeeeeee0000050000eeeee000000500000005000000050000f000f000000000000000000000000000000000000000000000000000000000000000000
0ffffff0ef1ff1e000777700eeeefee00077770000777700007777000ffffff00000000000000000000000000000000000000000000000000000000000000000
0f1fff10eeffffe007778770ef1ff1e00777877007778770077787700f1fff100000000000000000000000000000000000000000000000000000000000000000
0effffe0eeccce0007177710eeffffe00717771007177710071777100effffe00000000000000000000000000000000000000000000000000000000000000000
002220000877700007777770eeccce00077777700777777007777770002220000000000000000000000000000000000000000000000000000000000000000000
0f88800000000800099999900077700009999990099999900999999000888f000000000000000000000000000000000000000000000000000000000000000000
0000f000000000000a000a000080800000a00a0000a000a00a0000a000f000000000000000000000000000000000000000000000000000000000000000000000
00000000007666700007670000777700000000000000000000076700000000000000000000000000000000000000000000000000000000000000000000000000
00777700000050000000500007778770000000000f000f0000005000007777000000000000000000000000000000000000000000000000000000000000000000
0777b770007777000077770007777770007007000ffffff000777700077787700000000000000000000000000000000000000000000000000000000000000000
07777770077787700777877007177710000770000f1fff1007778770077777700000000000000000000000000000000000000000000000000000000000000000
07177710071777100717771007777770000770000effffe007177710071777100000000000000000000000000000000000000000000000000000000000000000
077777700777777007777770a9999990007007000022200007777770077777700000000000000000000000000000000000000000000000000000000000000000
09999990099999900999999000000a000000000000888000099999900999999a0000000000000000000000000000000000000000000000000000000000000000
0a0000a000a000a00a0000a0000000000000000000f0f0000a0000a000a000000000000000000000000000000000000000000000000000000000000000000000
