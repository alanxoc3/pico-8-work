g_obj_map = split[[
 bed        -- 1   | 39  | 1  | 2
,signtest   -- 2   | 24  | 1  | 1
,pot        -- 3   | 49  | 1  | 1
,house231   -- 4   | 174 | 2  | 2
,navyblock  -- 5   | 97  | 1  | 1

,signlank   -- 6   | 24  | 1  | 1
,signkeep   -- 7   | 24  | 1  | 1
,signnavy   -- 8   | 24  | 1  | 1
,signteach  -- 9   | 24  | 1  | 1
,signlark   -- 10  | 24  | 1  | 1
,signjane   -- 11  | 24  | 1  | 1

,house224   -- 12  | 174 | 2  | 2
,house225   -- 13  | 174 | 2  | 2
,house226   -- 14  | 174 | 2  | 2
,house227   -- 15  | 174 | 2  | 2
,house228   -- 16  | 174 | 2  | 2
,house229   -- 17  | 174 | 2  | 2

,navyhouse  -- 18  | 97  | 1  | 1
,bobblock   -- 19  | 80  | 1  | 1
,bobhouse   -- 20  | 80  | 1  | 1
,nil        -- 21  | 0   | 1  | 1
,nil        -- 22  | 0   | 1  | 1
,nil        -- 23  | 0   | 1  | 1
,nil        -- 24  | 0   | 1  | 1
,nil        -- 25  | 0   | 1  | 1
,nil        -- 26  | 0   | 1  | 1
,nil        -- 27  | 0   | 1  | 1
,nil        -- 28  | 0   | 1  | 1
,nil        -- 29  | 0   | 1  | 1
,nil        -- 30  | 0   | 1  | 1
,nil        -- 31  | 0   | 1  | 1
,nil        -- 32  | 0   | 1  | 1
,nil        -- 33  | 0   | 1  | 1
,nil        -- 34  | 0   | 1  | 1
,nil        -- 35  | 0   | 1  | 1
,nil        -- 36  | 0   | 1  | 1
,nil        -- 37  | 0   | 1  | 1
,nil        -- 38  | 0   | 1  | 1
,nil        -- 39  | 0   | 1  | 1
,nil        -- 40  | 0   | 1  | 1
,nil        -- 41  | 0   | 1  | 1
,nil        -- 42  | 0   | 1  | 1
,nil        -- 43  | 0   | 1  | 1
,nil        -- 44  | 0   | 1  | 1
,nil        -- 45  | 0   | 1  | 1
,nil        -- 46  | 0   | 1  | 1
,nil        -- 47  | 0   | 1  | 1
,nil        -- 48  | 0   | 1  | 1
,nil        -- 49  | 0   | 1  | 1
,nil        -- 50  | 0   | 1  | 1
,nil        -- 51  | 0   | 1  | 1
,nil        -- 52  | 0   | 1  | 1
,nil        -- 53  | 0   | 1  | 1
,nil        -- 54  | 0   | 1  | 1
,nil        -- 55  | 0   | 1  | 1
,nil        -- 56  | 0   | 1  | 1
,nil        -- 57  | 0   | 1  | 1
,nil        -- 58  | 0   | 1  | 1
,nil        -- 59  | 0   | 1  | 1
,nil        -- 60  | 0   | 1  | 1
,nil        -- 61  | 0   | 1  | 1
,nil        -- 62  | 0   | 1  | 1
,nil        -- 63  | 0   | 1  | 1
,nil        -- 64  | 0   | 1  | 1
,nil        -- 65  | 0   | 1  | 1
,nil        -- 66  | 0   | 1  | 1
,nil        -- 67  | 0   | 1  | 1
,nil        -- 68  | 0   | 1  | 1
,nil        -- 69  | 0   | 1  | 1
,nil        -- 70  | 0   | 1  | 1
,nil        -- 71  | 0   | 1  | 1
,nil        -- 72  | 0   | 1  | 1
,nil        -- 73  | 0   | 1  | 1
,nil        -- 74  | 0   | 1  | 1
,nil        -- 75  | 0   | 1  | 1
,nil        -- 76  | 0   | 1  | 1
,nil        -- 77  | 0   | 1  | 1
,nil        -- 78  | 0   | 1  | 1
,nil        -- 79  | 0   | 1  | 1
,nil        -- 80  | 0   | 1  | 1
,nil        -- 81  | 0   | 1  | 1
,nil        -- 82  | 0   | 1  | 1
,nil        -- 83  | 0   | 1  | 1
,nil        -- 84  | 0   | 1  | 1
,nil        -- 85  | 0   | 1  | 1
,nil        -- 86  | 0   | 1  | 1
,nil        -- 87  | 0   | 1  | 1
,nil        -- 88  | 0   | 1  | 1
,nil        -- 89  | 0   | 1  | 1
,nil        -- 90  | 0   | 1  | 1
,nil        -- 91  | 0   | 1  | 1
,nil        -- 92  | 0   | 1  | 1
,nil        -- 93  | 0   | 1  | 1
,nil        -- 94  | 0   | 1  | 1
,nil        -- 95  | 0   | 1  | 1
,nil        -- 96  | 0   | 1  | 1
,nil        -- 97  | 0   | 1  | 1
,nil        -- 98  | 0   | 1  | 1
,nil        -- 99  | 0   | 1  | 1
,nil        -- 100 | 0   | 1  | 1
,nil        -- 101 | 0   | 1  | 1
,nil        -- 102 | 0   | 1  | 1
,nil        -- 103 | 0   | 1  | 1
,nil        -- 104 | 0   | 1  | 1
,nil        -- 105 | 0   | 1  | 1
,nil        -- 106 | 0   | 1  | 1
,nil        -- 107 | 0   | 1  | 1
,nil        -- 108 | 0   | 1  | 1
,nil        -- 109 | 0   | 1  | 1
,nil        -- 110 | 0   | 1  | 1
,nil        -- 111 | 0   | 1  | 1
,nil        -- 112 | 0   | 1  | 1
,nil        -- 113 | 0   | 1  | 1
,nil        -- 114 | 0   | 1  | 1
,nil        -- 115 | 0   | 1  | 1
,nil        -- 116 | 0   | 1  | 1
,nil        -- 117 | 0   | 1  | 1
,nil        -- 118 | 0   | 1  | 1
,nil        -- 119 | 0   | 1  | 1
,nil        -- 120 | 0   | 1  | 1
,nil        -- 121 | 0   | 1  | 1
,nil        -- 122 | 0   | 1  | 1
,nil        -- 123 | 0   | 1  | 1
,nil        -- 124 | 0   | 1  | 1
,nil        -- 125 | 0   | 1  | 1
,nil        -- 126 | 0   | 1  | 1
,nil        -- 127 | 0   | 1  | 1
,nil        -- 128 | 0   | 1  | 1
]]

-- {
--   [y*16+x]: {
--     w:12, h:10,
--     tiles_1: {[y*12+x]: 0},
--     tiles_2: {[y*12+x]: 0},
--     objects: {{x:0, y:0, index:0}...},
--     color:0,
--     music:0,
--     get_spr
--   }
-- }

function decode_map()
    local rooms, cur_loc = {}, 0x2000
    local peek_inc = function()
        cur_loc += 1
        return @(cur_loc-1)
    end

    while @cur_loc ~= CON_END do
        local room, room_ind = zobj[[tiles_1;,;tiles_2;,;objects;,;w,ROOM_W,h,ROOM_H,color,0,music,0]], peek_inc()
        if room_ind > LAST_ROOM_INDEX then room.w, room.h = HUT_W, HUT_H end

        room.color = 0x0f & @cur_loc
        room.music = 0xf0 & peek_inc() >>> 4

        local byte, is_tile, layer, ind, offx, offy, is_fill = 0, true, room.tiles_1, 0, 0, 0
        while byte ~= CON_END do
            byte = peek_inc()

            if byte >= CON_L1 and byte <= CON_OBJ_55 then
                is_fill, is_tile = nil
            end

            if     byte == CON_L1     then is_tile = true  layer = room.tiles_1
            elseif byte == CON_L2     then is_tile = true  layer = room.tiles_2
            elseif byte == CON_OBJ_00 then offx = 0  offy = 0
            elseif byte == CON_OBJ_50 then offx = .5 offy = 0
            elseif byte == CON_OBJ_05 then offx = 0  offy = .5
            elseif byte == CON_OBJ_55 then offx = .5 offy = .5
            elseif byte == CON_FILL   then is_fill = true
            elseif byte < 128         then ind = byte
            elseif byte < CON_END     then
                local p1 = 0x7f & byte
                if is_tile then
                    if is_fill then
                        local p2 = 0x7f & peek_inc()
                        for yy=p1\12,p2\12 do
                            for xx=p1%12,p2%12 do
                                layer[yy*12+xx] = ind+128
                            end
                        end
                    else
                        layer[p1] = ind+128
                    end
                else
                    add(room.objects, {index=ind+1, x=p1%12+offx, y=p1\12+offy})
                end
            end
        end

        rooms[room_ind] = room
    end

    return rooms
end
