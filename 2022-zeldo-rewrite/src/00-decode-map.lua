g_obj_map = split[[
 bedpillow   -- 0   | 39  | 1  | 1
,bedbot_l    -- 1   | 55  | 1  | 1
,pot         -- 2   | 49  | 1  | 1
,house231    -- 3   | 174 | 2  | 2
,navyblock   -- 4   | 97  | 1  | 1

,signlank    -- 5   | 24  | 1  | 1
,signkeep    -- 6   | 24  | 1  | 1
,signnavy    -- 7   | 24  | 1  | 1
,signteach   -- 8   | 24  | 1  | 1
,signlark    -- 9   | 24  | 1  | 1
,signjane    -- 10  | 24  | 1  | 1

,house224    -- 11  | 174 | 2  | 2
,house225    -- 12  | 174 | 2  | 2
,house226    -- 13  | 174 | 2  | 2
,house227    -- 14  | 174 | 2  | 2
,house228    -- 15  | 174 | 2  | 2
,house229    -- 16  | 174 | 2  | 2

,navyhouse   -- 17  | 97  | 1  | 1
,bobblock    -- 18  | 80  | 1  | 1
,bobhouse    -- 19  | 80  | 1  | 1

,bedbot_r    -- 20  | 55  | 1  | 1
,teach       -- 21  | 96  | 1  | 1
,jane        -- 22  | 81  | 1  | 1
,lark        -- 23  | 99  | 1  | 1

,r1spike     -- 24  | 52  | 1  | 1
,r2spike     -- 25  | 54  | 1  | 1
,l1spike     -- 26  | 52  | 1  | 1 | 1
,l2spike     -- 27  | 54  | 1  | 1 | 1
,saveplat    -- 28  | 40  | 2  | 2
,woodtbl     -- 29  | 16  | 1  | 1
,greytbl     -- 30  | 17  | 1  | 1
,soupbucket  -- 31  | 18  | 1  | 1
,slimy       -- 32  | 118 | 1  | 1
,miny        -- 33  | 116 | 1  | 1
,woodcrate   -- 34  | 35  | 1  | 1
,quack       -- 35  | 32  | 1  | 1
,nil         -- 36  | 0   | 1  | 1
,keep_brang  -- 37  | 83  | 1  | 1
,keep_shield -- 38  | 83  | 1  | 1
,keep_sling  -- 39  | 83  | 1  | 1
,keep_mask   -- 40  | 83  | 1  | 1
,slobs       -- 41  | 120 | 1  | 1
,slobs_miny  -- 42  | 117 | 1  | 1
,nil         -- 43  | 0   | 1  | 1
,nil         -- 44  | 0   | 1  | 1
,nil         -- 45  | 0   | 1  | 1
,nil         -- 46  | 0   | 1  | 1
,nil         -- 47  | 0  | 1  | 1
,coin_1      -- 48  | 36  | 1  | 1
,coin_2      -- 49  | 36  | 1  | 1
,coin_3      -- 50  | 36  | 1  | 1
,coin_4      -- 51  | 36  | 1  | 1
,coin_5      -- 52  | 36  | 1  | 1
,coin_6      -- 53  | 36  | 1  | 1
,coin_7      -- 54  | 36  | 1  | 1
,coin_8      -- 55  | 36  | 1  | 1
,coin_9      -- 56  | 36  | 1  | 1
,coin_10     -- 57  | 36  | 1  | 1
,coin_11     -- 58  | 36  | 1  | 1
,coin_12     -- 59  | 36  | 1  | 1
,coin_13     -- 60  | 36  | 1  | 1
,coin_14     -- 61  | 36  | 1  | 1
,coin_15     -- 62  | 36  | 1  | 1
,coin_16     -- 63  | 36  | 1  | 1
,nil         -- 64  | 0   | 1  | 1
,nil         -- 65  | 0   | 1  | 1
,nil         -- 66  | 0   | 1  | 1
,nil         -- 67  | 0   | 1  | 1
,nil         -- 68  | 0   | 1  | 1
,nil         -- 69  | 0   | 1  | 1
,nil         -- 70  | 0   | 1  | 1
,nil         -- 71  | 0   | 1  | 1
,nil         -- 72  | 0   | 1  | 1
,nil         -- 73  | 0   | 1  | 1
,nil         -- 74  | 0   | 1  | 1
,nil         -- 75  | 0   | 1  | 1
,nil         -- 76  | 0   | 1  | 1
,nil         -- 77  | 0   | 1  | 1
,nil         -- 78  | 0   | 1  | 1
,nil         -- 79  | 0   | 1  | 1
,nil         -- 80  | 0   | 1  | 1
,nil         -- 81  | 0   | 1  | 1
,nil         -- 82  | 0   | 1  | 1
,nil         -- 83  | 0   | 1  | 1
,nil         -- 84  | 0   | 1  | 1
,nil         -- 85  | 0   | 1  | 1
,nil         -- 86  | 0   | 1  | 1
,nil         -- 87  | 0   | 1  | 1
,nil         -- 88  | 0   | 1  | 1
,nil         -- 89  | 0   | 1  | 1
,nil         -- 90  | 0   | 1  | 1
,nil         -- 91  | 0   | 1  | 1
,nil         -- 92  | 0   | 1  | 1
,nil         -- 93  | 0   | 1  | 1
,nil         -- 94  | 0   | 1  | 1
,nil         -- 95  | 0   | 1  | 1
,nil         -- 96  | 0   | 1  | 1
,nil         -- 97  | 0   | 1  | 1
,nil         -- 98  | 0   | 1  | 1
,nil         -- 99  | 0   | 1  | 1
,nil         -- 100 | 0   | 1  | 1
,nil         -- 101 | 0   | 1  | 1
,nil         -- 102 | 0   | 1  | 1
,nil         -- 103 | 0   | 1  | 1
,nil         -- 104 | 0   | 1  | 1
,nil         -- 105 | 0   | 1  | 1
,nil         -- 106 | 0   | 1  | 1
,nil         -- 107 | 0   | 1  | 1
,nil         -- 108 | 0   | 1  | 1
,nil         -- 109 | 0   | 1  | 1
,nil         -- 110 | 0   | 1  | 1
,nil         -- 111 | 0   | 1  | 1
,nil         -- 112 | 0   | 1  | 1
,nil         -- 113 | 0   | 1  | 1
,nil         -- 114 | 0   | 1  | 1
,nil         -- 115 | 0   | 1  | 1
,nil         -- 116 | 0   | 1  | 1
,nil         -- 117 | 0   | 1  | 1
,nil         -- 118 | 0   | 1  | 1
,nil         -- 119 | 0   | 1  | 1
,nil         -- 120 | 0   | 1  | 1
,nil         -- 121 | 0   | 1  | 1
,nil         -- 122 | 0   | 1  | 1
,nil         -- 123 | 0   | 1  | 1
,nil         -- 124 | 0   | 1  | 1
,nil         -- 125 | 0   | 1  | 1
,nil         -- 126 | 0   | 1  | 1
,nil         -- 127 | 0   | 1  | 1
]]

-- {
--   [y*16+x]: {
--     w:12, h:10,
--     tiles_1: {[y*12+x]: 0},
--     tiles_2: {[y*12+x]: 0},
--     objects: {{x:0, y:0, index:0}...},
--     color:0,
--     music:0,
--     get_spr
--   }
-- }

function decode_map()
    local rooms, cur_loc = {}, 0x2000
    local peek_inc = function()
        cur_loc += 1
        return @(cur_loc-1)
    end

    while @cur_loc ~= CON_END do
        local room, room_ind = zobj[[tiles_1;,;tiles_2;,;objects;,;w,ROOM_W,h,ROOM_H,color,0,music,0]], peek_inc()
        if room_ind > LAST_ROOM_INDEX then room.w, room.h = HUT_W, HUT_H end

        room.color = 0x0f & @cur_loc
        room.music = (0xf0 & peek_inc()) >>> 4

        local byte, is_tile, layer, ind, offx, offy, is_place = 0, true, room.tiles_1, 0, 0, 0
        while byte ~= CON_END do
            byte = peek_inc()

            if byte >= CON_L1 and byte <= CON_OBJ_55 then
                is_place, is_tile = nil
            end

            if     byte == CON_L1     then is_tile = true  layer = room.tiles_1
            elseif byte == CON_L2     then is_tile = true  layer = room.tiles_2
            elseif byte == CON_OBJ_00 then offx = 0  offy = 0
            elseif byte == CON_OBJ_50 then offx = .5 offy = 0
            elseif byte == CON_OBJ_05 then offx = 0  offy = .5
            elseif byte == CON_OBJ_55 then offx = .5 offy = .5
            elseif byte == CON_TILE   then is_place = true
            elseif byte < 128         then ind = byte
            elseif byte < CON_END     then
                local p1 = 0x7f & byte
                if is_tile then
                    if is_place then
                        layer[p1] = ind+128
                    else
                        local p2 = 0x7f & peek_inc()
                        for yy=p1\12,p2\12 do
                            for xx=p1%12,p2%12 do
                                layer[yy*12+xx] = ind+128
                            end
                        end
                    end
                else
                    add(room.objects, {index=ind+1, x=p1%12+offx, y=p1\12+offy})
                end
            end
        end

        rooms[room_ind] = room
    end

    return rooms
end
